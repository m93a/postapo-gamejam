<!doctype html>
<meta charset=utf-8>
<title>Postapo</title>
<style>

#col{
float:right;
width:max-content;
width:moz-max-content;
width:webkit-max-content;
}
table{
max-width:100%;
overflow:scroll;
}
td,div{
position:relative;
border:5px solid gray;
font-size:3rem;
color: #ccc;
width:64px;
height:64px;
line-height:64px;
text-align:center;
}
span{
font-size:.8rem;
font-family:sans-serif;
font-weight:bold;
position:absolute;
top:0;left:0;
background:white;
border-radius:50%;
width:16px;
height:16px;
line-height:16px;
}
span:empty{display:none;}
div,p{
float:right;
clear:right;
}
p{
top:100px;
border:1px solid;
}
h3{
margin:0;
}

.p1{color:blue;}
.p2{color:green;}

[x='0']{background:black;}
[x='1']{background:yellow;}
[x='2']{background:red;}
[x0='0']{border-top-color:black;}
[x0='1']{border-top-color:yellow;}
[x0='2']{border-top-color:red;}
[x1='0']{border-right-color:black;}
[x1='1']{border-right-color:yellow;}
[x1='2']{border-right-color:red;}
[x2='0']{border-bottom-color:black;}
[x2='1']{border-bottom-color:yellow;}
[x2='2']{border-bottom-color:red;}
[x3='0']{border-left-color:black;}
[x3='1']{border-left-color:yellow;}
[x3='2']{border-left-color:red;}

</style>
<br>
<script>

var a, /* world object,
Table element extended by { ...-1: trElem,
0: trElem, 1: trElem... }, where trElem are
<tr> elements extended by { ...-1: tdElem,
0: tdElem, 1: tdElem... }, where tdElem are
<td> elements extended by the corresponding
item of the tile stack and {p: spanElem }
which shows no. of people on the tile */

b=document.body,

c={n:0}, /* active tile,
Random tile from the tile stack, extended
by {n: int}, where int is the index of the tile */

d={a:0, m:0, p:1,s:0}, /* game data
a – step counter, no. of t() calls
m – mode 0=place tile, 1=wait, 2=move, 3=build
p – which player's turn it is
s – "stage" or "phase" of the game,
    0=init, 1=rise, 2=stall, 3=fall */

e,f,

g=window,
h,i,j,k, //iterators
l=console.log.bind(console),
m=(x)=>x*Math.random()|0, //random int from 0 to x
n=(a,i)=>a.splice(i,1)[0], //pop i-th element from array a

o, /* click listener,
Listener for the click event of td elements */

p=(e)=>e.preventDefault()+r()&&false, //right-click listener

q,

r =()=>([c[0],c[1],c[2],c[3]]=[c[3],c[0],c[1],c[2]],aa.u()),
/* rotate tile,
Listener for the click event of the tile hinter,
rotates the active tile */

s=[], /* tile stack,
Contains objects with properties 0 to 3
for tile sides top, right, bottom, left.
Values of those are numbers 0 to 2
corresponding to the three zone types */

t, //next turn

u=undefined,

v,w,
x,y,z, //temp. vars
col, //left&right column
aa, //active tile
cc, //controls panel
dd, //visible data

btp, rlt,
tp, rt, lt, bt, /* extend the plane,
tp = Add a row to the top,
bt = Add a row to the bottom,
rt = Add a column to the right,
lt = Add a column to the bottom */

E=(x)=>document.createElement(x),
I=(x)=>document.getElementById(x);

x=Element.prototype;
x.ac=x.appendChild;
x.bc=function(x){return this.insertBefore(x,this.children[0])};
x.sa=x.setAttribute;
x.ga=x.getAttribute;

o=function(e){
 var i=-1,x,y=0,
 t=e.target;
 
 if(d.m==1){
  return;
 }
 if(d.m==2){
  return;
 }
 if(d.m==3){
  return;
 }
 
 if(x=(a[t.x-1]||{})[t.y]){
  if(x){if(x[2]!=u && x[2]!=c[0])return;x[1]!=u?y=1:0;}
 }
 if(x=(a[t.x+1]||{})[t.y]){
  if(x){if(x[0]!=u && x[0]!=c[2])return;x[1]!=u?y=1:0;}
 }
 if(x=a[t.x][t.y-1]){
  if(x){if(x[1]!=u && x[1]!=c[3])return;x[1]!=u?y=1:0;}
 }
 if(x=a[t.x][t.y+1]){
  if(x){if(x[3]!=u && x[3]!=c[1])return;x[1]!=u?y=1:0;}
 }
 if(!y&&!t.prim){return l(4);}
 
 i=-1;
 while(++i<4)
 t.sa("x"+i,c[i]),
 t[i]=c[i];
 t.sa("x",c.z);
 
 a[t.x-1]||tp();
 a[t.x+1]||bt();
 a[t.x][t.y-1]||lt();
 a[t.x][t.y+1]||rt();
 
 (d.s==0)&&(t.p.className="p"+d.p)&&(t.p.textContent=dd[d.p].p);
 
 g.t();
};

btp=function(t){
 var i=0,j,x,mn=0,mx=0;
 if(t){
  while(a[--i]);
  a[i]=E("tr");
  a.bc(a[i]);
 }else{
  while(a[++i]);
  a[i]=E("tr");
  a.ac(a[i]);
 }
 
 while(a[0][++mx]);
 while(a[0][--mn]);
 
 while(mn++<mx-1){
  x=a[i][mn]=E("td");
  x.x=i;x.y=mn;
  a[i].ac(x);
  x.onclick=o;
  x.ac(x.p=E("span"));
 }
};

rlt=function(r){
 var i=0,j,x,mn=0,mx=0;
 
 while(a[++mx]);
 while(a[--mn]);
 
 if(r){
  j=0;while(a[0][++j]);
 }else{
  j=0;while(a[0][--j]);
 }
 
 while(mn++<mx-1){
  x=a[mn][j]=E("td");
  x.x=mn;x.y=j;
  r?a[mn].ac(x):a[mn].bc(x);
  x.onclick=o;
  x.ac(x.p=E("span"));
 }
};

tp=()=>btp(1);
bt=()=>btp(0);
rt=()=>rlt(1);
lt=()=>rlt(0);

t=function(){
 d.a++;d.a==2&&d.s++;
 
 d.m=d.m==0?1:0;
 
 if(d.m==1){
  c={};aa.u();
  return;
 }
 
 var x=dd[d.p];
 
 n(s,c.n);
 x=m(s.length);
 c=s[x];
 c.n=x;
 aa.u();
 
 x.f-=x.p;
 (x.f<0)&&((x.p+=x.f),x.f=0);
 (x.p<1)&&(alert("Player "+d.p+" lost"));
 d.p==1?d.p=2:d.p=1;
 aa.textContent=d.p;
 dd.u();
};


b.oncontextmenu=p;

col=E("section");
col.id="col";
b.ac(col);

x=E("table");
b.ac(x);
a=x;

i=-1;
while(++i<128)
s.push({0:m(3),1:m(3),2:m(3),3:m(3),z:m(3)});
c=s[0];
c.n=0;

aa=E("div");
col.ac(aa);
aa.u=function(){
 var i=-1;
 while(++i<4)
 aa.sa("x"+i,c[i]),
 aa[i]=c[i];
 aa.sa("x",c.z);
};
aa.textContent=1;
aa.onclick=r;
aa.u();

cc=E("p");
cc.innerHTML="<button id=bb>Build</button><button id=bm>Move"+
"</button><button id=be>End turn</button>";
col.ac(cc);
I("be").onclick=t;
I("bm").onclick=()=>d.m=2;
I("bb").onclick=()=>d.m=3;

dd=E("p");
dd.innerHTML="<h3 class=p1>Player 1</h3>Population: <output id=p1></output><br>"+
"Food: <output id=f1></output><br>Junk: <output id=j1></output>"+
"<h3 class=p2>Player 2</h3>Population: <output id=p2></output><br>"+
"Food: <output id=f2></output><br>Junk: <output id=j2></output>";
col.ac(dd);

x=function(){
 var i=0,j,x=["p","f","j"],l=3,y;
 while(j=-1,++i<3){
  dd[i]={p:2,f:10,j:0};
  while(++j<l) dd[i][x[j]+"n"]=I(x[j]+i);
}};
x();

dd.u=function(){
 var i=0,j,x=["p","f","j"],l=3;
 while(j=-1,++i<3)while(++j<l)
 dd[i][x[j]+"n"].textContent=dd[i][x[j]];
};
dd.u();


a[0]=E("tr");
a.ac(a[0]);
x=a[0][0]=E("td");
x.x=0;x.y=0;
a[0].ac(x);
x.onclick=o;
x.prim=1;
x.ac(x.p=E("span"));

</script>
